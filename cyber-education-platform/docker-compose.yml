name: cedrik
services:
  # ===== NO MORE SINGLE KALI WORKSTATION =====
  # We don't pre-create a single kali-workstation anymore
  # Instead, we'll spawn them dynamically from the pre-built image
  
  # ===== BUILD THE KALI IMAGE (one-time) =====
  # This service ONLY builds the image, doesn't run a container
  kali-base:
    build: ./kali-custom
    image: kali-custom:latest
    profiles: ["build-only"]  # This means it won't start with docker-compose up
    # We only run this when we want to rebuild: docker-compose build kali-base

  # ===== NOVNC PROXY (Keep for now, though each user will get their own) =====
   # ===== NOVNC PROXY =====
  # novnc:
  #   build: ./novnc-custom
  #   container_name: novnc
  #   ports:
  #     - "127.0.0.1:6080:6080"
  #   networks:
  #     - hack-lab-network
  #   restart: unless-stopped

  # ===== SCENARIO CONTAINERS =====
  scenario-webapp:
    image: vulnerables/web-dvwa
    container_name: scenario-webapp
    hostname: dvwa.lab
    networks:
      - hack-lab-network
    ports:
      - "127.0.0.1:8081:80"
    environment:
      - MYSQL_ROOT_PASSWORD=dvwa
      - MYSQL_DATABASE=dvwa
      - MYSQL_USER=dvwa
      - MYSQL_PASSWORD=p@ssw0rd
    restart: unless-stopped

  scenario-sqli:
    image: acgpiano/sqli-labs
    container_name: scenario-sqli
    hostname: sqli.lab
    networks:
      - hack-lab-network
    ports:
      - "127.0.0.1:8082:80"
    restart: unless-stopped

  scenario-wordpress:
    image: eystsen/vulnerablewordpress
    container_name: scenario-wordpress
    hostname: wordpress.lab
    networks:
      - hack-lab-network
    ports:
      - "127.0.0.1:8083:80"
      - "127.0.0.1:3306:3306"
    restart: unless-stopped

  scenario-metasploitable:
    image: tleemcjr/metasploitable2
    container_name: scenario-metasploitable
    hostname: metasploitable.lab
    networks:
      - hack-lab-network
    ports:
      - "127.0.0.1:2222:22"
      - "127.0.0.1:8084:80"
      - "127.0.0.1:21:21"
      - "127.0.0.1:23:23"
    tty: true
    stdin_open: true
    restart: unless-stopped

  scenario-webgoat:
    image: webgoat/webgoat-8.0
    container_name: scenario-webgoat
    hostname: webgoat.lab
    networks:
      - hack-lab-network
    ports:
      - "127.0.0.1:8085:8080"
    environment:
      - WEBGOAT_HOST=0.0.0.0
      - WEBGOAT_PORT=8080
    restart: unless-stopped

  scenario-juiceshop:
    image: bkimminich/juice-shop
    container_name: scenario-juiceshop
    hostname: juiceshop.lab
    networks:
      - hack-lab-network
    ports:
      - "127.0.0.1:8086:3000"
    restart: unless-stopped

  # ===== DATABASE =====
  postgres:
    image: postgres:15-alpine
    container_name: cyber-db
    environment:
      - POSTGRES_DB=cyber_education
      - POSTGRES_USER=cyber_admin
      - POSTGRES_PASSWORD=secure_pass_123
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./dbinit/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - hack-lab-network
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cyber_admin -d cyber_education"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  # ===== BRIDGE SERVER (Enhanced with Container Management) =====
  bridge-server:
    build: ./bridge-server
    container_name: cyber-bridge
    ports:
      - "127.0.0.1:3000:3000"
    networks:
      - hack-lab-network
      - cedrik-internal  # ✅ Connect to cedrik's network
    environment:
      - BACKEND_MAIN_API_URL=${BACKEND_MAIN_API_URL}
      - SERVERURL=${SERVERURL}
      # - SERVERURL=https://localhost
      - DOCKER_HOST=unix:///var/run/docker.sock
      - DATABASE_URL=postgresql://cyber_admin:secure_pass_123@postgres:5432/cyber_education
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - JWT_SECRET=your-secret-key-change-this
      # Container Management Config
      - KALI_IMAGE=kali-custom:latest
      - MAX_CONCURRENT_CONTAINERS=10
      - CONTAINER_IDLE_TIMEOUT=1800000
      - POOL_SIZE=3
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./shared:/shared
      - ./logs:/app/logs
      - ./.env:/app/.env:ro
    depends_on:
      postgres:
        condition: service_healthy
      scenario-webapp:
        condition: service_started
    restart: unless-stopped
    privileged: true

  # ===== WEB UI ===== (✅ RESTORED - We definitely need this!)
  web-ui:
    build: ./web-ui
    container_name: cyber-web-ui
    ports:
      - "127.0.0.1:8069:80"
    networks:
      - hack-lab-network
      - cedrik-internal  # ✅ Also connect to cedrik network for main backend access
    depends_on:
      - bridge-server
    restart: unless-stopped

networks:
  cedrik-internal:
    name: cedrik-internal
    external: true  # ✅ Created by main cedrik compose
  hack-lab-network:
    driver: bridge
    name: hack-lab-network

volumes:
  postgres-data:
  # Note: We don't have kali-home volume anymore since each user gets their own container
